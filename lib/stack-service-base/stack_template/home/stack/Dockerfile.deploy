FROM ruby:3.4.4-slim-bookworm AS base
RUN apt update && apt install -y --no-install-recommends openssh-client ca-certificates
RUN gem install build-labels:0.0.75 dry-stack:0.1.53
RUN install-docker-static

WORKDIR /build
RUN mkdir -p /root/.ssh && mkdir -pv /root/.ssh/sockets
RUN echo -e 'Host *\n\tControlPersist yes\n\tControlMaster auto\n\tControlPath  /root/.ssh/sockets/%r@%h-%p\n\tBatchMode yes\n\tStrictHostKeyChecking no\n\tPort 22' > ~/.ssh/config
ADD . .

CMD ["sh", "-c", "\
    cat otlp.drs stack.drs  | dry-stack swarm_deploy --tls-domain=example.com -x ssh://example.com -- --prune \n\
"]
