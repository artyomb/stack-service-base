FROM ruby:3.3.0-alpine3.19 as base
RUN apk add docker-cli-buildx git parallel
RUN gem install build-labels:0.0.55 dry-stack:0.1.51
RUN apk add --no-cache openssh-client ca-certificates

WORKDIR /build
RUN mkdir -p /root/.ssh && mkdir -pv /root/.ssh/sockets
RUN echo -e 'Host *\n\tControlPersist yes\n\tControlMaster auto\n\tControlPath  /root/.ssh/sockets/%r@%h-%p\n\tBatchMode yes\n\tStrictHostKeyChecking no\n\tPort 22' > ~/.ssh/config
ADD . .

CMD ["sh", "-c", "\
    cat otlp.drs stack.drs  | dry-stack swarm_deploy --tls-domain=example.com -x ssh://example.com -- --prune \n\
"]
